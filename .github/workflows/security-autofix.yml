# GitHub Action: Automated Security Scanner
# 
# This workflow scans for security vulnerabilities and auto-fixes what it can.
# Add this to any repo's .github/workflows/ directory.
#
# For multi-repo scanning, create a dedicated "security-ops" repo and use
# a PAT with repo scope to scan across all your repositories.

name: Security Auto-Fix

on:
  schedule:
    # Run every Monday at 6am UTC
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      fix_mode:
        description: 'Fix mode'
        required: true
        default: 'auto-fix'
        type: choice
        options:
          - auto-fix
          - report-only

permissions:
  contents: write
  security-events: write
  pull-requests: write

jobs:
  scan-and-fix:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Check for Dependabot alerts
      id: dependabot
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Checking Dependabot alerts..."
        ALERTS=$(gh api repos/${{ github.repository }}/dependabot/alerts \
          --jq '[.[] | select(.state=="open")] | length' 2>/dev/null || echo "0")
        echo "open_alerts=$ALERTS" >> $GITHUB_OUTPUT
        
        if [ "$ALERTS" -gt 0 ]; then
          echo "::warning::Found $ALERTS open Dependabot alerts"
          gh api repos/${{ github.repository }}/dependabot/alerts \
            --jq '.[] | select(.state=="open") | "- \(.security_advisory.severity): \(.security_advisory.summary)"' \
            2>/dev/null || true
        fi

    - name: Auto-fix Python dependencies
      if: steps.dependabot.outputs.open_alerts != '0' && inputs.fix_mode != 'report-only'
      run: |
        echo "Attempting to fix Python dependency vulnerabilities..."
        
        # Find requirements files
        for req_file in $(find . -name "requirements*.txt" -not -path "./.git/*"); do
          echo "Processing $req_file..."
          
          # Install pip-audit
          pip install pip-audit -q
          
          # Get vulnerable packages and their fixed versions
          pip-audit -r "$req_file" --fix --dry-run 2>/dev/null || true
          
          # Actually fix if not dry-run
          pip-audit -r "$req_file" --fix 2>/dev/null || true
        done
        
    - name: Commit fixes
      if: inputs.fix_mode != 'report-only'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add -A
          git commit -m "fix(security): auto-update vulnerable dependencies

        Automated security fix by GitHub Actions.
        
        ðŸ¤– Generated by security-scan workflow"
          git push
          echo "::notice::Committed security fixes"
        fi

    - name: Summary
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Dependabot alerts found**: ${{ steps.dependabot.outputs.open_alerts }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Fix mode**: ${{ inputs.fix_mode || 'auto-fix' }}" >> $GITHUB_STEP_SUMMARY
