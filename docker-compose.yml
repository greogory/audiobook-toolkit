# Audiobooks - Docker Compose Configuration
#
# Quick Start:
#   export AUDIOBOOK_DIR=/path/to/your/audiobooks
#   docker-compose up -d
#
# Access:
#   Web UI: https://localhost:8443 (HTTPS)
#           http://localhost:8080 (redirects to HTTPS)
#
# First-time setup (scan audiobooks):
#   docker exec -it audiobooks python3 /app/scanner/scan_audiobooks.py
#   docker exec -it audiobooks python3 /app/backend/import_to_db.py
#
# Note: Browser will show security warning (self-signed certificate)
#       Click 'Advanced' -> 'Proceed to localhost' to continue

services:
  audiobooks:
    # Option 1: Pull from GHCR (recommended)
    image: ghcr.io/greogory/audiobook-toolkit:latest
    # Option 2: Build locally (uncomment below, comment out image above)
    # build: .
    container_name: audiobooks
    ports:
      - "${WEB_PORT:-8443}:8443"   # HTTPS web interface
      - "${HTTP_PORT:-8080}:8080"  # HTTP redirect to HTTPS
      # Note: API port 5001 is internal only (not exposed)
    volumes:
      # Mount your audiobook directory (read-only for safety)
      # The Library subdirectory contains converted OPUS files
      - ${AUDIOBOOK_DIR:-/path/to/audiobooks}:/audiobooks:ro

      # Mount supplements directory (PDFs, course materials, etc.)
      - ${SUPPLEMENTS_DIR:-/path/to/supplements}:/supplements:ro

      # Persist database across container restarts
      - audiobooks_data:/app/data

      # Persist cover art cache
      - audiobooks_covers:/app/covers

    environment:
      # Path to audiobooks inside container
      - AUDIOBOOK_DIR=/audiobooks

      # Database location (persisted via volume)
      - DATABASE_PATH=/app/data/audiobooks.db

      # Cover art cache location
      - COVER_DIR=/app/covers

      # Supplements directory (PDFs, maps, etc.)
      - SUPPLEMENTS_DIR=/supplements

      # Server ports (match exposed ports)
      - WEB_PORT=8443
      - API_PORT=5001
      - HTTP_REDIRECT_PORT=8080
      - AUDIOBOOKS_USE_WAITRESS=true
      - HTTP_REDIRECT_ENABLED=true

    restart: unless-stopped

    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

volumes:
  audiobooks_data:
    name: audiobooks_data
    driver: local
  audiobooks_covers:
    name: audiobooks_covers
    driver: local

# Network configuration (optional)
networks:
  default:
    name: audiobooks_network
