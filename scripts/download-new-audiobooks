#!/bin/bash
# =============================================================================
# Automated Audible Audiobook Downloader
# =============================================================================
# Checks for new audiobooks and downloads them with KDE notifications
# Rate-limited to avoid API issues
# =============================================================================

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "${SCRIPT_DIR}/../lib/audiobooks-config.sh" ]]; then
    source "${SCRIPT_DIR}/../lib/audiobooks-config.sh"
elif [[ -f "/opt/audiobooks/lib/audiobooks-config.sh" ]]; then
    source "/opt/audiobooks/lib/audiobooks-config.sh"
elif [[ -f "/usr/local/lib/audiobooks/audiobooks-config.sh" ]]; then
    source "/usr/local/lib/audiobooks/audiobooks-config.sh"
else
    echo "ERROR: Cannot find audiobooks-config.sh" >&2
    exit 1
fi

# Configuration
DOWNLOAD_DIR="${AUDIOBOOKS_SOURCES}"
LIBRARY_DIR="${AUDIOBOOKS_LIBRARY}"
LOG_DIR="${AUDIOBOOKS_LOGS}"
LOG_FILE="${LOG_DIR}/audiobook_downloader.log"
LOCK_FILE="${AUDIOBOOKS_RUN_DIR:-/run/audiobooks}/downloader.lock"
TEMP_DIR="${AUDIOBOOKS_RUN_DIR:-/run/audiobooks}/download-temp"
SKIP_LIST="${AUDIOBOOKS_VAR_DIR:-/var/lib/audiobooks}/audiobook-skip-list.txt"
AUDIBLE_CMD="${AUDIOBOOKS_AUDIBLE_CMD:-/usr/bin/audible}"

# Rate limiting: seconds between downloads
DOWNLOAD_DELAY="${AUDIOBOOKS_DOWNLOAD_DELAY:-30}"

# tmpfs usage threshold (pause downloads if /tmp exceeds this)
TMPFS_MAX_USAGE="${AUDIOBOOKS_TMPFS_THRESHOLD:-85}"

# Color codes for terminal
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

mkdir -p "$LOG_DIR" "$TEMP_DIR" "$(dirname "$LOCK_FILE")" "$(dirname "$SKIP_LIST")"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

notify() {
    local title="$1"
    local message="$2"
    local icon="${3:-audio-x-generic}"
    notify-send -a "Audiobook Downloader" -i "$icon" "$title" "$message" 2>/dev/null || true
}

# Check tmpfs usage and wait if too high
check_tmpfs_space() {
    local USAGE=$(df /tmp | tail -1 | awk '{print int($5)}')

    if [ "$USAGE" -ge "$TMPFS_MAX_USAGE" ]; then
        log "tmpfs usage at ${USAGE}% (threshold: ${TMPFS_MAX_USAGE}%) - pausing downloads..."
        notify "Audiobook Downloader" "Paused - tmpfs at ${USAGE}%" "dialog-warning"

        while [ "$USAGE" -ge "$TMPFS_MAX_USAGE" ]; do
            sleep 30
            USAGE=$(df /tmp | tail -1 | awk '{print int($5)}')
        done

        log "tmpfs usage now at ${USAGE}% - resuming downloads"
        notify "Audiobook Downloader" "Resumed - tmpfs at ${USAGE}%" "emblem-default"
        return 0
    fi

    return 0
}

# Prevent concurrent runs
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    log "Another instance is already running. Exiting."
    exit 1
fi

log "=========================================="
log "Audiobook Downloader Started"
log "=========================================="

# Get list of all ASINs in library with titles
log "Fetching library from Audible..."
"$AUDIBLE_CMD" library export -f tsv -o "$TEMP_DIR/library.tsv" 2>&1 | tee -a "$LOG_FILE"

if [ ! -s "$TEMP_DIR/library.tsv" ]; then
    log "ERROR: Failed to fetch library"
    echo -e "${RED}ERROR: Failed to fetch library${NC}"
    notify "Audiobook Downloader" "Failed to fetch library from Audible" "dialog-error"
    exit 1
fi

# Subtract 1 for header line
TOTAL_LIBRARY=$(($(wc -l < "$TEMP_DIR/library.tsv") - 1))

# Filter out podcasts, newspapers, and other non-audiobook content
awk -F'\t' 'NR==1 {for(i=1;i<=NF;i++) if($i=="runtime_length_min") col=i} NR>1 && $col != "" {print $1}' "$TEMP_DIR/library.tsv" | sort -u > "$TEMP_DIR/library_asins.txt"

AUDIOBOOK_COUNT=$(wc -l < "$TEMP_DIR/library_asins.txt")
NON_AUDIOBOOK_COUNT=$((TOTAL_LIBRARY - AUDIOBOOK_COUNT))

log "Library contains $TOTAL_LIBRARY items total"
log "Audiobooks: $AUDIOBOOK_COUNT"
log "Filtered out $NON_AUDIOBOOK_COUNT podcasts/newspapers/series"

# Check for and remove corrupted files (0 bytes or very small)
log "Checking for corrupted files..."
CORRUPTED_COUNT=0

while IFS= read -r FILE; do
    SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo "0")
    if [ "$SIZE" -lt 102400 ]; then
        log "REMOVING CORRUPTED: $(basename "$FILE") (size: $SIZE bytes)"
        rm -f "$FILE"
        ((CORRUPTED_COUNT++))
    fi
done < <(find "$DOWNLOAD_DIR" \( -name "*.aaxc" -o -name "*.aax" \) -type f 2>/dev/null)

while IFS= read -r FILE; do
    SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo "0")
    if [ "$SIZE" -lt 102400 ]; then
        log "REMOVING CORRUPTED: $(basename "$FILE") (size: $SIZE bytes)"
        rm -f "$FILE"
        ((CORRUPTED_COUNT++))
    fi
done < <(find "$LIBRARY_DIR" -name "*.opus" -type f ! -name "*.cover.opus" 2>/dev/null)

while IFS= read -r FILE; do
    SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo "0")
    if [ "$SIZE" -lt 102400 ]; then
        log "REMOVING CORRUPTED: $(basename "$FILE") (size: $SIZE bytes)"
        rm -f "$FILE"
        ((CORRUPTED_COUNT++))
    fi
done < <(find "$LIBRARY_DIR" -name "*.m4b" -type f 2>/dev/null)

if [ "$CORRUPTED_COUNT" -gt 0 ]; then
    log "Removed $CORRUPTED_COUNT corrupted files"
    notify "Audiobook Downloader" "Removed $CORRUPTED_COUNT corrupted files" "emblem-important"
fi

# Get list of already downloaded ASINs
> "$TEMP_DIR/downloaded_asins.txt"

find "$DOWNLOAD_DIR" \( -name "*.aaxc" -o -name "*.aax" \) -type f -size +100k 2>/dev/null | \
    xargs -I {} basename {} | \
    grep -oE '^[0-9A-Z]{10}' >> "$TEMP_DIR/downloaded_asins.txt"

find "$LIBRARY_DIR" -name "*.opus" -type f ! -name "*.cover.opus" -size +100k 2>/dev/null | \
    xargs -I {} basename {} .opus | \
    grep -oE '^[0-9A-Z]{10}' >> "$TEMP_DIR/downloaded_asins.txt"

sort -u "$TEMP_DIR/downloaded_asins.txt" -o "$TEMP_DIR/downloaded_asins.txt"

DOWNLOADED_COUNT=$(wc -l < "$TEMP_DIR/downloaded_asins.txt")
log "Already downloaded: $DOWNLOADED_COUNT audiobooks"

# Load permanent skip list
touch "$SKIP_LIST"

# Find ASINs not yet downloaded
comm -23 "$TEMP_DIR/library_asins.txt" "$TEMP_DIR/downloaded_asins.txt" > "$TEMP_DIR/temp_new.txt"
PENDING_COUNT=$(wc -l < "$TEMP_DIR/temp_new.txt")

# Filter out books in skip list
comm -23 "$TEMP_DIR/temp_new.txt" <(sort "$SKIP_LIST") > "$TEMP_DIR/new_asins.txt"

SKIP_COUNT=$(wc -l < "$SKIP_LIST")
FILTERED_COUNT=$((PENDING_COUNT - $(wc -l < "$TEMP_DIR/new_asins.txt")))

if [ "$SKIP_COUNT" -gt 0 ]; then
    log "Skip list contains $SKIP_COUNT non-downloadable books"
    if [ "$FILTERED_COUNT" -gt 0 ]; then
        log "Filtered out $FILTERED_COUNT books from skip list this run"
    fi
fi

NEW_COUNT=$(wc -l < "$TEMP_DIR/new_asins.txt")

if [ "$NEW_COUNT" -eq 0 ]; then
    log "No new audiobooks to download"
    notify "Audiobook Downloader" "Library is up to date ($AUDIOBOOK_COUNT audiobooks)" "emblem-default"
    exit 0
fi

log "Found $NEW_COUNT new audiobooks to download"
notify "Audiobook Downloader" "Downloading $NEW_COUNT new audiobooks..." "emblem-downloads"

# Download new audiobooks with progress
CURRENT=0
SUCCESS=0
FAILED=0

while IFS=$'\t' read -r ASIN; do
    ((CURRENT++))

    check_tmpfs_space

    TITLE=$(grep "^$ASIN" "$TEMP_DIR/library.tsv" | cut -f2 | head -1)
    [ -z "$TITLE" ] && TITLE="$ASIN"

    DISPLAY_TITLE="${TITLE:0:50}"
    [ ${#TITLE} -gt 50 ] && DISPLAY_TITLE="${DISPLAY_TITLE}..."

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$CURRENT/$NEW_COUNT] Downloading: $DISPLAY_TITLE" >> "$LOG_FILE"
    echo -e "${CYAN}[$CURRENT/$NEW_COUNT]${NC} Downloading: $DISPLAY_TITLE"

    PERCENT=$((CURRENT * 100 / NEW_COUNT))
    notify "Downloading Audiobooks" "[$CURRENT/$NEW_COUNT] $DISPLAY_TITLE" "emblem-downloads"

    "$AUDIBLE_CMD" download \
        --aaxc \
        --asin "$ASIN" \
        --output-dir "$DOWNLOAD_DIR" \
        --filename-mode asin_ascii \
        --ignore-errors \
        2>> "$LOG_FILE"

    if find "$DOWNLOAD_DIR" -name "${ASIN}*" -type f \( -name "*.aaxc" -o -name "*.aax" \) -print -quit | grep -q .; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] ✓ Downloaded: $DISPLAY_TITLE" >> "$LOG_FILE"
        echo -e "${GREEN}✓ Downloaded:${NC} $DISPLAY_TITLE"
        ((SUCCESS++))
    else
        echo "  Trying AAX fallback..." | tee -a "$LOG_FILE"
        "$AUDIBLE_CMD" download \
            --aax-fallback \
            --asin "$ASIN" \
            --output-dir "$DOWNLOAD_DIR" \
            --filename-mode asin_ascii \
            --ignore-errors \
            2>> "$LOG_FILE"

        if find "$DOWNLOAD_DIR" -name "${ASIN}*" -type f \( -name "*.aaxc" -o -name "*.aax" \) -print -quit | grep -q .; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ✓ Downloaded (AAX fallback): $DISPLAY_TITLE" >> "$LOG_FILE"
            echo -e "${GREEN}✓ Downloaded (AAX):${NC} $DISPLAY_TITLE"
            ((SUCCESS++))
        else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] ✗ Failed (not downloadable): $DISPLAY_TITLE" >> "$LOG_FILE"
            echo -e "${RED}✗ Failed (not downloadable):${NC} $DISPLAY_TITLE"
            ((FAILED++))
            echo "$ASIN" >> "$SKIP_LIST"
            sort -u "$SKIP_LIST" -o "$SKIP_LIST"
        fi
    fi

    if [ $CURRENT -lt $NEW_COUNT ]; then
        sleep $DOWNLOAD_DELAY
    fi

done < "$TEMP_DIR/new_asins.txt"

log "=========================================="
log "Download complete: $SUCCESS succeeded, $FAILED failed"
log "=========================================="

if [ $FAILED -eq 0 ]; then
    notify "Audiobook Downloader" "Downloaded $SUCCESS new audiobooks successfully!" "emblem-default"
else
    notify "Audiobook Downloader" "Downloaded $SUCCESS audiobooks, $FAILED failed" "dialog-warning"
fi

# Cleanup
rm -f "$TEMP_DIR/library.tsv" "$TEMP_DIR/library_asins.txt" \
      "$TEMP_DIR/downloaded_asins.txt" "$TEMP_DIR/new_asins.txt" \
      "$TEMP_DIR/temp_new.txt"
