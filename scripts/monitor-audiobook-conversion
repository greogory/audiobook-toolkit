#!/bin/bash
# =============================================================================
# Audiobook Conversion Progress Monitor
# =============================================================================
# Shows live updates for parallel Opus conversions including:
# - Progress bar and completion percentage
# - Conversion rate (books/minute) and ETA
# - System resource usage and process priorities
# - Active conversion list
#
# Usage: monitor-audiobook-conversion [interval_seconds]
# =============================================================================

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "${SCRIPT_DIR}/../lib/audiobooks-config.sh" ]]; then
    source "${SCRIPT_DIR}/../lib/audiobooks-config.sh"
elif [[ -f "/opt/audiobooks/lib/audiobooks-config.sh" ]]; then
    source "/opt/audiobooks/lib/audiobooks-config.sh"
elif [[ -f "/usr/local/lib/audiobooks/audiobooks-config.sh" ]]; then
    source "/usr/local/lib/audiobooks/audiobooks-config.sh"
fi

# Configuration
INTERVAL="${1:-10}"
LOG_DIR="$AUDIOBOOKS_LOGS"
STAGING_DIR="$AUDIOBOOKS_STAGING"
LIBRARY_DIR="$AUDIOBOOKS_LIBRARY"
SOURCES_DIR="$AUDIOBOOKS_SOURCES"

# Ensure display environment for desktop notifications
export DISPLAY="${DISPLAY:-:0}"
export DBUS_SESSION_BUS_ADDRESS="${DBUS_SESSION_BUS_ADDRESS:-unix:path=/run/user/$(id -u)/bus}"

DBUS_REF=""

# Rate tracking variables
PREV_COUNT=0
PREV_TIME=$(date +%s)
RATE="measuring..."
ETA_MINS="calculating..."

cleanup() {
    if [ -n "$DBUS_REF" ]; then
        qdbus $DBUS_REF close 2>/dev/null
    fi
    tput cnorm  # Restore cursor
    echo ""
    exit 0
}

trap cleanup EXIT INT TERM

# Color codes
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

get_counts() {
    AAXC_COUNT=$(find "$SOURCES_DIR" -maxdepth 1 -name "*.aaxc" -type f 2>/dev/null | wc -l)
    STAGED_COUNT=$(find "$STAGING_DIR" -name "*.opus" -type f ! -name "*.cover.opus" 2>/dev/null | wc -l)
    LIBRARY_COUNT=$(find "$LIBRARY_DIR" -name "*.opus" -type f ! -name "*.cover.opus" 2>/dev/null | wc -l)
    TOTAL_CONVERTED=$((LIBRARY_COUNT + STAGED_COUNT))
    REMAINING=$((AAXC_COUNT - TOTAL_CONVERTED))
    [[ $REMAINING -lt 0 ]] && REMAINING=0
}

get_system_stats() {
    FFMPEG_COUNT=$(pgrep -c -f "ffmpeg.*libopus" 2>/dev/null || echo 0)
    FFMPEG_NICE=$(ps -eo ni,comm 2>/dev/null | grep ffmpeg | head -1 | awk '{print $1}')
    CPU_IDLE=$(top -b -n 1 2>/dev/null | grep "Cpu(s)" | awk '{print $8}' | cut -d'.' -f1)
    LOAD=$(cat /proc/loadavg 2>/dev/null | awk '{print $1}')
    TMPFS_USAGE=$(df /tmp 2>/dev/null | tail -1 | awk '{print $5}')
    TMPFS_AVAIL=$(df -h /tmp 2>/dev/null | tail -1 | awk '{print $4}')
}

calculate_rate() {
    local NOW=$(date +%s)
    local ELAPSED=$((NOW - PREV_TIME))

    if [[ $ELAPSED -ge 10 && $PREV_COUNT -gt 0 ]]; then
        local DELTA=$((TOTAL_CONVERTED - PREV_COUNT))
        if [[ $DELTA -gt 0 ]]; then
            RATE=$(echo "scale=1; $DELTA * 60 / $ELAPSED" | bc 2>/dev/null || echo "?")
            if [[ -n "$RATE" && "$RATE" != "0" && "$RATE" != "?" ]]; then
                ETA_MINS=$(echo "scale=0; $REMAINING / $RATE" | bc 2>/dev/null || echo "?")
            else
                ETA_MINS="?"
            fi
        fi
        PREV_COUNT=$TOTAL_CONVERTED
        PREV_TIME=$NOW
    elif [[ $PREV_COUNT -eq 0 ]]; then
        PREV_COUNT=$TOTAL_CONVERTED
        PREV_TIME=$NOW
    fi
}

draw_progress_bar() {
    local PERCENT=$1
    local WIDTH=40
    local FILLED=$((PERCENT * WIDTH / 100))
    local EMPTY=$((WIDTH - FILLED))
    printf "%${FILLED}s" | tr ' ' '█'
    printf "%${EMPTY}s" | tr ' ' '░'
}

tput civis  # Hide cursor
clear

while true; do
    tput cup 0 0

    get_counts
    get_system_stats
    calculate_rate

    local PERCENT=0
    [[ $AAXC_COUNT -gt 0 ]] && PERCENT=$((TOTAL_CONVERTED * 100 / AAXC_COUNT))

    echo -e "${BOLD}${CYAN}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}${CYAN}║         AUDIOBOOK CONVERSION MONITOR                         ║${NC}"
    echo -e "${BOLD}${CYAN}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # Progress bar
    printf "  ${BOLD}Progress:${NC} [${GREEN}"
    draw_progress_bar $PERCENT
    printf "${NC}] ${BOLD}%d%%${NC}\n" "$PERCENT"
    echo ""

    # File counts
    echo "  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    printf "  ${BOLD}Source files:${NC}    %-6d   ${BOLD}Active ffmpeg:${NC} %d (nice=%s)\n" "$AAXC_COUNT" "$FFMPEG_COUNT" "${FFMPEG_NICE:-?}"
    printf "  ${BOLD}In library:${NC}      ${GREEN}%-6d${NC}   ${BOLD}tmpfs:${NC} %s (%s free)\n" "$LIBRARY_COUNT" "$TMPFS_USAGE" "$TMPFS_AVAIL"
    printf "  ${BOLD}In staging:${NC}      ${YELLOW}%-6d${NC}   ${BOLD}CPU idle:${NC} %s%%  ${BOLD}Load:${NC} %s\n" "$STAGED_COUNT" "${CPU_IDLE:-?}" "${LOAD:-?}"
    printf "  ${BOLD}Remaining:${NC}       ${CYAN}%-6d${NC}\n" "$REMAINING"
    echo "  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Rate and ETA
    printf "  ${BOLD}Conversion rate:${NC} ${GREEN}%s${NC} books/min\n" "$RATE"
    printf "  ${BOLD}Est. remaining:${NC}  ${CYAN}%s${NC} minutes\n" "$ETA_MINS"
    echo ""

    # Active conversions
    if [ "$FFMPEG_COUNT" -gt 0 ]; then
        echo -e "  ${GREEN}${BOLD}Active Conversions:${NC}"
        ps aux 2>/dev/null | grep "ffmpeg.*libopus" | grep -v grep | while read line; do
            OUTPUT=$(echo "$line" | grep -oP '(?<=-f ogg ")[^"]+' | xargs -r basename 2>/dev/null | head -c 45)
            [ -n "$OUTPUT" ] && echo "    • $OUTPUT"
        done | head -6
    else
        echo -e "  ${YELLOW}No active conversions${NC}"
    fi

    echo ""
    echo -e "  Last updated: $(date '+%H:%M:%S') (refresh: ${INTERVAL}s) | Ctrl+C to exit"

    # Clear any remaining content
    tput ed

    # Check completion
    if [[ $REMAINING -eq 0 && $AAXC_COUNT -gt 0 ]]; then
        echo ""
        echo -e "  ${GREEN}${BOLD}✓ ALL CONVERSIONS COMPLETE!${NC}"
        sleep 5
        break
    fi

    sleep "$INTERVAL"
done
