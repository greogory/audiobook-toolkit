#!/bin/bash
# =============================================================================
# Audiobook Conversion Progress Monitor
# =============================================================================
# Shows live updates for parallel Opus conversions
# with individual and overall progress
# =============================================================================

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "${SCRIPT_DIR}/../lib/audiobooks-config.sh" ]]; then
    source "${SCRIPT_DIR}/../lib/audiobooks-config.sh"
elif [[ -f "/opt/audiobooks/lib/audiobooks-config.sh" ]]; then
    source "/opt/audiobooks/lib/audiobooks-config.sh"
elif [[ -f "/usr/local/lib/audiobooks/audiobooks-config.sh" ]]; then
    source "/usr/local/lib/audiobooks/audiobooks-config.sh"
fi

# Configuration
LOG_DIR="${AUDIOBOOKS_LOGS:-/var/log/audiobooks}"
STAGING_DIR="${AUDIOBOOKS_STAGING:-/tmp/audiobook-staging}"
LIBRARY_DIR="${AUDIOBOOKS_LIBRARY:-/srv/audiobooks/Library}"
SOURCES_DIR="${AUDIOBOOKS_SOURCES:-/srv/audiobooks/Sources}"

# Ensure display environment for desktop notifications
export DISPLAY="${DISPLAY:-:0}"
export DBUS_SESSION_BUS_ADDRESS="${DBUS_SESSION_BUS_ADDRESS:-unix:path=/run/user/$(id -u)/bus}"

DBUS_REF=""

cleanup() {
    if [ -n "$DBUS_REF" ]; then
        qdbus $DBUS_REF close 2>/dev/null
    fi
    exit 0
}

trap cleanup EXIT INT TERM

# Color codes
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

clear
echo -e "${CYAN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║         AUDIOBOOK CONVERSION MONITOR                       ║${NC}"
echo -e "${CYAN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo "Press Ctrl+C to exit"
echo ""

while true; do
    # Move cursor to line 6
    tput cup 5 0

    # Count files
    AAXC_COUNT=$(find "$SOURCES_DIR" -maxdepth 1 -name "*.aaxc" -type f 2>/dev/null | wc -l)
    STAGED_COUNT=$(find "$STAGING_DIR" -name "*.opus" -type f ! -name "*.cover.opus" 2>/dev/null | wc -l)
    LIBRARY_COUNT=$(find "$LIBRARY_DIR" -name "*.opus" -type f ! -name "*.cover.opus" 2>/dev/null | wc -l)
    FFMPEG_COUNT=$(pgrep -c ffmpeg 2>/dev/null || echo 0)

    # tmpfs usage
    TMPFS_USAGE=$(df /tmp | tail -1 | awk '{print $5}')
    TMPFS_AVAIL=$(df -h /tmp | tail -1 | awk '{print $4}')

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    printf "  Source files:    %-6d   Active conversions: %d\n" "$AAXC_COUNT" "$FFMPEG_COUNT"
    printf "  Staged files:    %-6d   tmpfs usage: %s (%s free)\n" "$STAGED_COUNT" "$TMPFS_USAGE" "$TMPFS_AVAIL"
    printf "  Library files:   %-6d\n" "$LIBRARY_COUNT"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Show active conversions
    if [ "$FFMPEG_COUNT" -gt 0 ]; then
        echo -e "${GREEN}Active Conversions:${NC}"
        ps aux | grep ffmpeg | grep -v grep | while read line; do
            # Extract the output filename from ffmpeg command
            OUTPUT=$(echo "$line" | grep -oP '(?<=-f ogg ")[^"]+' | xargs basename 2>/dev/null | head -c 50)
            [ -n "$OUTPUT" ] && echo "  • $OUTPUT"
        done | head -8
    else
        echo -e "${YELLOW}No active conversions${NC}"
    fi

    echo ""
    echo "Last updated: $(date '+%H:%M:%S')"

    # Clear remaining lines
    tput el

    sleep 5
done
