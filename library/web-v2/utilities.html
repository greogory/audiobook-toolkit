<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Back Office - Library Utilities</title>
    <link rel="stylesheet" href="css/library.css">
    <link rel="stylesheet" href="css/utilities.css">
</head>
<body class="back-office">
    <!-- Header -->
    <header class="office-header">
        <div class="header-content">
            <div class="header-left">
                <a href="index.html" class="back-link" title="Return to The Library">
                    <span class="back-icon">&#8592;</span>
                    <span class="back-text">The Library</span>
                </a>
            </div>
            <div class="header-center">
                <h1 class="office-title">The Back Office</h1>
                <p class="office-subtitle">Library Administration & Utilities · v3.5.0</p>
            </div>
            <div class="header-right">
                <!-- Classic Banker's Lamp SVG -->
                <svg class="banker-lamp-svg" viewBox="0 0 100 120" width="80" height="96" aria-label="Banker's desk lamp">
                    <defs>
                        <!-- Brass gradient for metal parts -->
                        <linearGradient id="brass-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#8b6914"/>
                            <stop offset="30%" style="stop-color:#d4a84b"/>
                            <stop offset="50%" style="stop-color:#ffd700"/>
                            <stop offset="70%" style="stop-color:#d4a84b"/>
                            <stop offset="100%" style="stop-color:#8b6914"/>
                        </linearGradient>
                        <!-- Green glass shade gradient -->
                        <linearGradient id="shade-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#4d8a6e"/>
                            <stop offset="50%" style="stop-color:#2d5a4e"/>
                            <stop offset="100%" style="stop-color:#1d3a2e"/>
                        </linearGradient>
                        <!-- Glow effect filter -->
                        <filter id="lamp-glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                        <!-- Inner glow for shade -->
                        <radialGradient id="inner-glow" cx="50%" cy="100%" r="80%">
                            <stop offset="0%" style="stop-color:#7dba9e;stop-opacity:0.6"/>
                            <stop offset="100%" style="stop-color:#2d5a4e;stop-opacity:0"/>
                        </radialGradient>
                    </defs>

                    <!-- Weighted base -->
                    <ellipse cx="50" cy="115" rx="28" ry="5" fill="url(#brass-gradient)"/>
                    <ellipse cx="50" cy="113" rx="25" ry="4" fill="#1a1512"/>
                    <ellipse cx="50" cy="112" rx="22" ry="3" fill="url(#brass-gradient)"/>

                    <!-- Base stem connector -->
                    <rect x="46" y="105" width="8" height="8" rx="1" fill="url(#brass-gradient)"/>

                    <!-- Lower arm (angled) -->
                    <rect x="47" y="70" width="6" height="38" rx="2" fill="url(#brass-gradient)" transform="rotate(-5 50 108)"/>

                    <!-- Joint/knuckle -->
                    <circle cx="49" cy="68" r="5" fill="url(#brass-gradient)"/>
                    <circle cx="49" cy="68" r="3" fill="#1a1512"/>
                    <circle cx="49" cy="68" r="2" fill="url(#brass-gradient)"/>

                    <!-- Upper arm (angled toward shade) -->
                    <rect x="38" y="45" width="5" height="26" rx="2" fill="url(#brass-gradient)" transform="rotate(15 40 68)"/>

                    <!-- Shade mount -->
                    <circle cx="50" cy="40" r="4" fill="url(#brass-gradient)"/>

                    <!-- Glass shade with glow -->
                    <g filter="url(#lamp-glow)">
                        <!-- Shade outer shell -->
                        <path d="M 20 40 Q 20 25 50 20 Q 80 25 80 40 L 75 42 Q 75 30 50 26 Q 25 30 25 42 Z"
                              fill="url(#shade-gradient)" stroke="#1d3a2e" stroke-width="1"/>
                        <!-- Shade rim (brass trim) -->
                        <path d="M 20 40 Q 20 43 50 45 Q 80 43 80 40"
                              fill="none" stroke="url(#brass-gradient)" stroke-width="2"/>
                        <!-- Inner glow overlay -->
                        <ellipse cx="50" cy="38" rx="25" ry="12" fill="url(#inner-glow)" opacity="0.7"/>
                    </g>

                    <!-- Light beam (subtle) -->
                    <ellipse cx="50" cy="115" rx="35" ry="3" fill="rgba(125, 186, 158, 0.15)"/>
                </svg>
            </div>
        </div>
    </header>

    <!-- Operation Status Banner (shown when operations are running) -->
    <div class="operation-status-banner" id="operation-status-banner" style="display: none;">
        <div class="status-banner-content">
            <div class="status-indicator">
                <span class="status-spinner"></span>
                <span class="status-label" id="status-operation-name">Operation Running</span>
            </div>
            <div class="status-progress">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="status-progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-percent" id="status-progress-percent">0%</span>
            </div>
            <div class="status-message" id="status-message">Initializing...</div>
            <button class="status-cancel-btn" id="status-cancel-btn" title="Cancel operation">✕</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="office-main">
        <!-- Navigation Tabs (Filing Cabinet Style) -->
        <nav class="filing-cabinet">
            <div class="cabinet-tabs">
                <button class="cabinet-tab active" data-section="database" title="Database statistics, maintenance, and backup operations">
                    <span class="tab-icon">&#128451;</span>
                    <span class="tab-label">Database</span>
                </button>
                <button class="cabinet-tab" data-section="conversion" title="Monitor audiobook conversion progress from AAXC to Opus">
                    <span class="tab-icon">&#127925;</span>
                    <span class="tab-label">Conversion</span>
                </button>
                <button class="cabinet-tab" data-section="duplicates" title="Find and manage duplicate audiobooks">
                    <span class="tab-icon">&#128464;</span>
                    <span class="tab-label">Duplicates</span>
                </button>
                <button class="cabinet-tab" data-section="audible" title="Sync metadata from Audible library exports">
                    <span class="tab-icon">&#127911;</span>
                    <span class="tab-label">Audible Sync</span>
                </button>
                <button class="cabinet-tab" data-section="bulk" title="Update or delete multiple audiobooks at once">
                    <span class="tab-icon">&#128230;</span>
                    <span class="tab-label">Bulk Ops</span>
                </button>
                <button class="cabinet-tab" data-section="system" title="Manage services and application upgrades">
                    <span class="tab-icon">&#9881;</span>
                    <span class="tab-label">System</span>
                </button>
            </div>
        </nav>

        <!-- Content Sections -->
        <div class="office-content">
            <!-- Database Management Section -->
            <section class="drawer-content active" id="database-section">
                <div class="section-header">
                    <h2>Database Management</h2>
                    <p class="section-desc">Statistics, maintenance, and backup operations</p>
                </div>

                <!-- Stats Overview -->
                <div class="card-catalog">
                    <div class="catalog-card">
                        <div class="card-header">Library Statistics</div>
                        <div class="card-body">
                            <div class="stat-grid">
                                <div class="stat-row">
                                    <span class="stat-label">Total Audiobooks</span>
                                    <span class="stat-value" id="db-total-books">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Total Duration</span>
                                    <span class="stat-value" id="db-total-hours">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Storage Used</span>
                                    <span class="stat-value" id="db-total-size">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Unique Authors</span>
                                    <span class="stat-value" id="db-total-authors">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Unique Narrators</span>
                                    <span class="stat-value" id="db-total-narrators">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Books with Hashes</span>
                                    <span class="stat-value" id="db-hash-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Duplicate Groups</span>
                                    <span class="stat-value" id="db-duplicate-groups">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Database Size</span>
                                    <span class="stat-value" id="db-file-size">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="office-btn" id="refresh-stats" title="Reload library statistics from database">
                                <span class="btn-icon">&#8635;</span> Refresh Stats
                            </button>
                        </div>
                    </div>

                    <div class="catalog-card">
                        <div class="card-header">Maintenance Operations</div>
                        <div class="card-body">
                            <div class="operation-list">
                                <div class="operation-item recommended">
                                    <div class="operation-info">
                                        <h4>Add New Audiobooks</h4>
                                        <p>Quick add - only scans files not already in database</p>
                                        <span class="operation-badge">Recommended</span>
                                    </div>
                                    <button class="office-btn primary" id="add-new-audiobooks" title="Fast incremental scan - finds new files without re-scanning existing ones">
                                        <span class="btn-icon">&#10133;</span> Add New
                                    </button>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Rescan Library</h4>
                                        <p>Full scan of audiobook directory (slow for large libraries)</p>
                                    </div>
                                    <button class="office-btn" id="rescan-library" title="Complete directory scan - updates all audiobook metadata">
                                        <span class="btn-icon">&#128269;</span> Full Scan
                                    </button>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Reimport Database</h4>
                                        <p>Rebuild database from scan results (preserves metadata)</p>
                                    </div>
                                    <button class="office-btn" id="reimport-db" title="Rebuild database from latest scan - use after manual file changes">
                                        <span class="btn-icon">&#128190;</span> Import
                                    </button>
                                </div>
                                <div class="operation-item" title="Regenerates ALL SHA-256 hashes for Library files (.opus). Use for integrity verification and database duplicate detection. Replaces existing hashes.">
                                    <div class="operation-info">
                                        <h4>Generate Hashes (SHA-256)</h4>
                                        <p>Full file hashes for Library - integrity verification</p>
                                    </div>
                                    <button class="office-btn" id="generate-hashes" title="Compute SHA-256 hashes for all library files">
                                        <span class="btn-icon">&#128274;</span> Generate
                                    </button>
                                </div>
                                <div class="operation-item" title="Regenerates ALL MD5 checksums for Sources (.aaxc) AND Library (.opus) files. Fast partial checksums (first 1MB) used for quick duplicate detection. Replaces existing index files.">
                                    <div class="operation-info">
                                        <h4>Generate Checksums (MD5)</h4>
                                        <p>Quick checksums for Sources + Library - duplicate detection</p>
                                    </div>
                                    <button class="office-btn" id="generate-checksums" title="Compute MD5 checksums for source and library files">
                                        <span class="btn-icon">&#128203;</span> Generate
                                    </button>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Vacuum Database</h4>
                                        <p>Optimize database and reclaim unused space</p>
                                    </div>
                                    <button class="office-btn" id="vacuum-db" title="SQLite VACUUM - defragment and shrink database file">
                                        <span class="btn-icon">&#128295;</span> Vacuum
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="catalog-card">
                        <div class="card-header">Backup & Export</div>
                        <div class="card-body">
                            <div class="operation-list">
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Export Database</h4>
                                        <p>Download a backup of the SQLite database</p>
                                    </div>
                                    <button class="office-btn" id="export-db" title="Download audiobooks.db SQLite file">
                                        <span class="btn-icon">&#128229;</span> Download
                                    </button>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Export to JSON</h4>
                                        <p>Export library metadata as JSON file</p>
                                    </div>
                                    <button class="office-btn" id="export-json" title="Export all audiobook metadata as JSON">
                                        <span class="btn-icon">&#128196;</span> Export
                                    </button>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Export to CSV</h4>
                                        <p>Export library listing as spreadsheet</p>
                                    </div>
                                    <button class="office-btn" id="export-csv" title="Export library as CSV spreadsheet">
                                        <span class="btn-icon">&#128200;</span> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Conversion Monitor Section -->
            <section class="drawer-content" id="conversion-section">
                <div class="section-header">
                    <h2>Conversion Monitor</h2>
                    <p class="section-desc">Track audiobook conversion progress from AAXC to Opus</p>
                </div>

                <!-- Remaining Summary Box -->
                <div class="remaining-summary" id="remaining-summary">
                    <span class="remaining-count" id="remaining-total">-</span>
                    <span class="remaining-text">of <span id="source-total">-</span> source books remaining</span>
                </div>

                <div class="card-catalog">
                    <!-- Main Progress Card -->
                    <div class="catalog-card wide">
                        <div class="card-header">
                            <span>Conversion Progress</span>
                            <span class="badge" id="conv-active-count">0 active</span>
                        </div>
                        <div class="card-body">
                            <!-- Progress Bar -->
                            <div class="conversion-progress-container">
                                <div class="conversion-progress-bar">
                                    <div class="conversion-progress-fill" id="conv-progress-fill" style="width: 0%"></div>
                                </div>
                                <div class="conversion-progress-info">
                                    <span class="progress-percent" id="conv-percent">0%</span>
                                    <span class="progress-eta" id="conv-eta">Calculating...</span>
                                </div>
                            </div>

                            <!-- Stats Grid -->
                            <div class="stat-grid conversion-stats">
                                <div class="stat-row">
                                    <span class="stat-label">Source Files (.aaxc)</span>
                                    <span class="stat-value" id="conv-source-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">In Library</span>
                                    <span class="stat-value success" id="conv-library-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">In Staging</span>
                                    <span class="stat-value warning" id="conv-staged-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Remaining</span>
                                    <span class="stat-value info" id="conv-remaining-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Queue Size</span>
                                    <span class="stat-value" id="conv-queue-count">-</span>
                                </div>
                                <div class="stat-row clickable" id="conv-rate-toggle" title="Click for detailed stats">
                                    <span class="stat-label">Conversion Rate <span class="expand-icon">▼</span></span>
                                    <span class="stat-value rate" id="conv-rate">- books/min</span>
                                </div>
                            </div>

                            <!-- Expandable Detailed Stats Panel -->
                            <div class="conversion-details-panel" id="conv-details-panel">
                                <div class="details-header">Detailed Conversion Statistics</div>
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Read Throughput</span>
                                        <span class="detail-value" id="conv-read-throughput">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Write Throughput</span>
                                        <span class="detail-value" id="conv-write-throughput">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Total Read</span>
                                        <span class="detail-value" id="conv-total-read">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Total Written</span>
                                        <span class="detail-value" id="conv-total-write">-</span>
                                    </div>
                                </div>
                                <div class="details-section">
                                    <div class="details-subheader">Queue Breakdown</div>
                                    <div class="queue-breakdown">
                                        <div class="breakdown-item">
                                            <span class="breakdown-label">Active conversions</span>
                                            <span class="breakdown-value" id="conv-active-detail">-</span>
                                        </div>
                                        <div class="breakdown-item">
                                            <span class="breakdown-label">Waiting in queue</span>
                                            <span class="breakdown-value" id="conv-queued-detail">-</span>
                                        </div>
                                        <div class="breakdown-item">
                                            <span class="breakdown-label">In staging</span>
                                            <span class="breakdown-value" id="conv-staging-detail">-</span>
                                        </div>
                                        <div class="breakdown-item">
                                            <span class="breakdown-label">Not yet queued</span>
                                            <span class="breakdown-value" id="conv-unqueued-detail">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="details-section" id="active-files-section">
                                    <div class="details-subheader">Currently Converting</div>
                                    <div class="active-files-list" id="conv-active-files">
                                        <span class="no-files">No active conversions</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <span class="last-updated" id="conv-last-updated">Never updated</span>
                            <button class="office-btn" id="conv-refresh" title="Refresh conversion progress and statistics">
                                <span class="btn-icon">&#8635;</span> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- System Stats Card -->
                    <div class="catalog-card">
                        <div class="card-header">System Resources</div>
                        <div class="card-body">
                            <div class="stat-grid">
                                <div class="stat-row">
                                    <span class="stat-label">Active FFmpeg Processes</span>
                                    <span class="stat-value" id="conv-ffmpeg-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Process Nice Value</span>
                                    <span class="stat-value" id="conv-ffmpeg-nice">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">System Load</span>
                                    <span class="stat-value" id="conv-load-avg">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">tmpfs Usage</span>
                                    <span class="stat-value" id="conv-tmpfs-usage">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">tmpfs Available</span>
                                    <span class="stat-value" id="conv-tmpfs-avail">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Conversions Card -->
                    <div class="catalog-card active-conversions-card">
                        <div class="card-header">
                            <span>Active Conversions</span>
                            <div class="sort-controls">
                                <span class="sort-label">Sort:</span>
                                <button class="sort-btn active" data-sort="percent" title="Sort by percent complete">%</button>
                                <button class="sort-btn" data-sort="throughput" title="Sort by throughput">MiB/s</button>
                                <button class="sort-btn" data-sort="name" title="Sort by name">A-Z</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="active-conversions-list" id="conv-active-list">
                                <p class="placeholder-text">No active conversions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto-refresh controls -->
                <div class="conversion-controls">
                    <label class="checkbox-option">
                        <input type="checkbox" id="conv-auto-refresh" checked>
                        <span>Auto-refresh every <select id="conv-refresh-interval" class="office-select small">
                            <option value="1">1s</option>
                            <option value="5" selected>5s</option>
                            <option value="10">10s</option>
                            <option value="15">15s</option>
                            <option value="30">30s</option>
                            <option value="60">60s</option>
                        </select></span>
                    </label>
                </div>
            </section>

            <!-- Duplicates Section -->
            <section class="drawer-content" id="duplicates-section">
                <div class="section-header">
                    <h2>Duplicate Management</h2>
                    <p class="section-desc">Find and remove duplicate audiobooks</p>
                </div>

                <div class="card-catalog">
                    <div class="catalog-card">
                        <div class="card-header">Detection Methods</div>
                        <div class="card-body">
                            <div class="detection-options">
                                <label class="radio-option" title="Compares title, author, narrator, and duration to find the same book in different editions or formats. May include files that are not byte-identical.">
                                    <input type="radio" name="dup-method" value="title" checked>
                                    <span class="radio-label">
                                        <strong>By Title/Author/Narrator</strong>
                                        <small>Find books with matching metadata (may be different files)</small>
                                    </span>
                                </label>
                                <label class="radio-option" title="Uses full SHA-256 hash from the database. Only works for Library files (.opus) that have been imported. Finds byte-identical duplicates.">
                                    <input type="radio" name="dup-method" value="hash">
                                    <span class="radio-label">
                                        <strong>By SHA-256 Hash</strong>
                                        <small>Find byte-identical files in Library (from database)</small>
                                    </span>
                                </label>
                                <label class="radio-option" title="Uses partial checksum (first 1MB) from index files. Scans Source folder (.aaxc files) to find duplicates before conversion. Works on files not yet in the database.">
                                    <input type="radio" name="dup-method" value="source-checksum">
                                    <span class="radio-label">
                                        <strong>Source File Checksums</strong>
                                        <small>Find duplicate .aaxc files in Sources folder</small>
                                    </span>
                                </label>
                                <label class="radio-option" title="Uses partial checksum (first 1MB) from index files. Scans Library folder (.opus files) directly, catching duplicates even if database is out of sync.">
                                    <input type="radio" name="dup-method" value="library-checksum">
                                    <span class="radio-label">
                                        <strong>Library File Checksums</strong>
                                        <small>Find duplicate .opus files in Library folder</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="office-btn primary" id="find-duplicates" title="Scan library for duplicate audiobooks using selected method">
                                <span class="btn-icon">&#128269;</span> Find Duplicates
                            </button>
                        </div>
                    </div>

                    <div class="catalog-card wide">
                        <div class="card-header">
                            <span>Duplicate Groups</span>
                            <span class="badge" id="dup-group-count">0</span>
                        </div>
                        <div class="card-body">
                            <div id="duplicates-list" class="duplicates-list">
                                <p class="placeholder-text">Click "Find Duplicates" to scan your library</p>
                            </div>
                        </div>
                        <div class="card-footer" id="dup-actions" style="display: none;">
                            <button class="office-btn secondary" id="select-all-dups" title="Select all duplicate files (keeps one original per group)">Select All Duplicates</button>
                            <button class="office-btn secondary" id="deselect-all-dups" title="Clear all selections">Deselect All</button>
                            <button class="office-btn danger" id="delete-selected-dups" disabled title="Permanently delete selected duplicate files">
                                <span class="btn-icon">&#128465;</span> Delete Selected (<span id="selected-count">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Audible Sync Section -->
            <section class="drawer-content" id="audible-section">
                <div class="section-header">
                    <h2>Audible Sync</h2>
                    <p class="section-desc">Sync metadata from your Audible library export</p>
                </div>

                <div class="card-catalog">
                    <!-- Prerequisites Card -->
                    <div class="catalog-card wide">
                        <div class="card-header">
                            <span>Prerequisites</span>
                            <span class="badge" id="audible-prereq-badge">Checking...</span>
                        </div>
                        <div class="card-body">
                            <div class="prereq-status" id="audible-prereq-status">
                                <div class="prereq-item">
                                    <span class="prereq-icon" id="metadata-json-icon">&#9898;</span>
                                    <div class="prereq-info">
                                        <h4>library_metadata.json</h4>
                                        <p id="metadata-json-status">Checking for Audible library export file...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="prereq-help" id="audible-prereq-help" style="display: none;">
                                <div class="help-notice">
                                    <span class="notice-icon">&#128712;</span>
                                    <div class="help-content">
                                        <h4>How to export your Audible library:</h4>
                                        <ol>
                                            <li>Use the <code>audible</code> CLI tool: <code>audible library export --format json</code></li>
                                            <li>Save the output as <code>library_metadata.json</code></li>
                                            <li>Place it in your audiobooks data directory</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="office-btn" id="check-audible-prereqs" title="Check if Audible library export file exists">
                                <span class="btn-icon">&#8635;</span> Check Prerequisites
                            </button>
                        </div>
                    </div>

                    <!-- Sync Operations Card -->
                    <div class="catalog-card">
                        <div class="card-header">Sync Operations</div>
                        <div class="card-body">
                            <div class="operation-list">
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Sync Genres</h4>
                                        <p>Populate genre metadata from Audible library export</p>
                                    </div>
                                    <div class="operation-controls">
                                        <label class="checkbox-option small" title="Preview changes without modifying database">
                                            <input type="checkbox" id="sync-genres-dryrun" checked>
                                            <span>Dry Run</span>
                                        </label>
                                        <button class="office-btn" id="sync-genres-btn" title="Sync genre metadata from Audible export">
                                            <span class="btn-icon">&#127991;</span> Sync Genres
                                        </button>
                                    </div>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Update Narrators</h4>
                                        <p>Update narrator names from Audible metadata</p>
                                    </div>
                                    <div class="operation-controls">
                                        <label class="checkbox-option small" title="Preview changes without modifying database">
                                            <input type="checkbox" id="sync-narrators-dryrun" checked>
                                            <span>Dry Run</span>
                                        </label>
                                        <button class="office-btn" id="sync-narrators-btn" title="Update narrator metadata from Audible export">
                                            <span class="btn-icon">&#127908;</span> Update Narrators
                                        </button>
                                    </div>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Populate Sort Fields</h4>
                                        <p>Generate author_sort and title_sort fields for proper sorting</p>
                                    </div>
                                    <div class="operation-controls">
                                        <label class="checkbox-option small" title="Preview changes without modifying database">
                                            <input type="checkbox" id="populate-sort-dryrun" checked>
                                            <span>Dry Run</span>
                                        </label>
                                        <button class="office-btn" id="populate-sort-btn" title="Generate sort fields for authors and titles">
                                            <span class="btn-icon">&#128292;</span> Populate Sort
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Operations Card -->
                    <div class="catalog-card">
                        <div class="card-header">Pipeline Operations</div>
                        <div class="card-body">
                            <div class="operation-list">
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Download New Audiobooks</h4>
                                        <p>Download new purchases from Audible to Sources folder</p>
                                    </div>
                                    <button class="office-btn primary" id="download-audiobooks-btn" title="Download new audiobooks from Audible account">
                                        <span class="btn-icon">&#128229;</span> Start Download
                                    </button>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Rebuild Conversion Queue</h4>
                                        <p>Regenerate queue.txt with all unconverted source files</p>
                                    </div>
                                    <button class="office-btn" id="rebuild-queue-btn" title="Rebuild the conversion queue from scratch">
                                        <span class="btn-icon">&#128259;</span> Rebuild Queue
                                    </button>
                                </div>
                                <div class="operation-item">
                                    <div class="operation-info">
                                        <h4>Cleanup Stale Indexes</h4>
                                        <p>Remove index entries for files that no longer exist</p>
                                    </div>
                                    <div class="operation-controls">
                                        <label class="checkbox-option small" title="Preview changes without deleting index entries">
                                            <input type="checkbox" id="cleanup-indexes-dryrun" checked>
                                            <span>Dry Run</span>
                                        </label>
                                        <button class="office-btn" id="cleanup-indexes-btn" title="Clean up stale index entries">
                                            <span class="btn-icon">&#128465;</span> Cleanup
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bulk Operations Section -->
            <section class="drawer-content" id="bulk-section">
                <div class="section-header">
                    <h2>Bulk Operations</h2>
                    <p class="section-desc">Update or delete multiple audiobooks at once</p>
                </div>

                <!-- Intro Card -->
                <div class="card-catalog">
                    <div class="catalog-card wide intro-card">
                        <div class="card-body">
                            <div class="intro-content">
                                <div class="intro-icon">&#128221;</div>
                                <div class="intro-text">
                                    <h3>How Bulk Operations Work</h3>
                                    <ol class="intro-steps">
                                        <li><strong>Filter</strong> — Choose which audiobooks to display using the filter options below</li>
                                        <li><strong>Select</strong> — Check the boxes next to audiobooks you want to modify</li>
                                        <li><strong>Act</strong> — Apply a bulk action to all selected items</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Selection Card -->
                    <div class="catalog-card wide">
                        <div class="card-header">Step 1: Filter Audiobooks</div>
                        <div class="card-body">
                            <div class="filter-explanation">
                                <p>Choose a filter to narrow down which audiobooks to display:</p>
                            </div>
                            <div class="bulk-filters">
                                <div class="filter-group">
                                    <label>Filter by:</label>
                                    <select id="bulk-filter-type" class="office-select">
                                        <option value="all">All Audiobooks — Show entire library</option>
                                        <option value="author">By Author — Find all books by a specific author</option>
                                        <option value="narrator">By Narrator — Find all books read by a specific narrator</option>
                                        <option value="series">By Series — Find all books in a specific series</option>
                                        <option value="no-narrator">Missing Narrator — Books without narrator metadata</option>
                                        <option value="no-hash">Missing Hash — Books not yet checksummed for integrity</option>
                                    </select>
                                </div>
                                <div class="filter-group" id="bulk-filter-value-group" style="display: none;">
                                    <label>Value:</label>
                                    <input type="text" id="bulk-filter-value" class="office-input" placeholder="Enter author, narrator, or series name...">
                                </div>
                                <button class="office-btn primary" id="bulk-load" title="Load audiobooks matching the selected filter">
                                    <span class="btn-icon">&#128269;</span> Load Audiobooks
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Card -->
                    <div class="catalog-card wide">
                        <div class="card-header">Step 2: Select Audiobooks</div>
                        <div class="card-body">
                            <div class="bulk-selection-bar" id="bulk-selection-bar" style="display: none;">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="bulk-select-all">
                                    <span>Select All</span>
                                </label>
                                <span class="selection-count"><span id="bulk-selected-count">0</span> selected</span>
                            </div>

                            <div id="bulk-list" class="bulk-list">
                                <p class="placeholder-text">Choose a filter above and click "Load Audiobooks" to see results</p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Card -->
                    <div class="catalog-card wide" id="bulk-actions-card" style="display: none;">
                        <div class="card-header">Step 3: Apply Bulk Action</div>
                        <div class="card-body">
                            <div class="bulk-action-list">
                                <div class="bulk-action-item">
                                    <div class="action-info">
                                        <h4>&#9998; Update Metadata Field</h4>
                                        <p>Set the same value for a metadata field across all selected audiobooks. Useful for:</p>
                                        <ul class="action-examples">
                                            <li>Adding a narrator to books missing one</li>
                                            <li>Correcting a publisher name across multiple titles</li>
                                            <li>Assigning books to a series</li>
                                        </ul>
                                    </div>
                                    <div class="action-controls">
                                        <select id="bulk-update-field" class="office-select" title="Choose which metadata field to update">
                                            <option value="">Select field to update...</option>
                                            <option value="narrator">Narrator</option>
                                            <option value="series">Series</option>
                                            <option value="publisher">Publisher</option>
                                        </select>
                                        <input type="text" id="bulk-update-value" class="office-input" placeholder="New value..." title="Enter the new value to apply to all selected audiobooks">
                                        <button class="office-btn" id="bulk-update-btn" title="Apply the new value to all selected audiobooks">Apply to Selected</button>
                                    </div>
                                </div>
                                <div class="bulk-action-item danger-zone">
                                    <div class="action-info">
                                        <h4>&#128465; Delete Selected Audiobooks</h4>
                                        <p>Permanently remove selected audiobooks from the database and filesystem. This action <strong>cannot be undone</strong>.</p>
                                    </div>
                                    <button class="office-btn danger" id="bulk-delete-btn" title="DANGER: Permanently delete selected audiobooks from database and disk">
                                        <span class="btn-icon">&#128465;</span> Delete Selected
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Administration Section -->
            <section class="drawer-content" id="system-section">
                <div class="section-header">
                    <h2>System Administration</h2>
                    <p class="section-desc">Manage services and application upgrades</p>
                </div>

                <div class="card-catalog">
                    <!-- Services Card -->
                    <div class="catalog-card wide">
                        <div class="card-header">
                            <span>Service Status</span>
                            <span class="badge" id="services-status-badge">Loading...</span>
                        </div>
                        <div class="card-body">
                            <div class="services-grid" id="services-list">
                                <!-- Services loaded dynamically -->
                                <p class="placeholder-text">Loading services...</p>
                            </div>
                        </div>
                        <div class="card-footer services-actions">
                            <button class="office-btn" id="refresh-services" title="Reload service status from systemd">
                                <span class="btn-icon">&#8635;</span> Refresh
                            </button>
                            <button class="office-btn success" id="start-all-services" title="Start all audiobook services (API, proxy, converter, mover, scanner)">
                                <span class="btn-icon">&#9654;</span> Start All
                            </button>
                            <button class="office-btn danger" id="stop-all-services" title="Stop ALL services including API and proxy. You will lose web access.">
                                <span class="btn-icon">&#9632;</span> Stop All
                            </button>
                            <button class="office-btn warning" id="stop-background-services" title="Stop only background processing (converter, mover, scanner). API and proxy stay running so you keep web access.">
                                <span class="btn-icon">&#9632;</span> Stop Background
                            </button>
                        </div>
                    </div>

                    <!-- Version Info Card -->
                    <div class="catalog-card">
                        <div class="card-header">Application Version</div>
                        <div class="card-body">
                            <div class="stat-grid">
                                <div class="stat-row">
                                    <span class="stat-label">Current Version</span>
                                    <span class="stat-value version" id="current-version">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Install Path</span>
                                    <span class="stat-value path" id="install-path">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upgrade Card -->
                    <div class="catalog-card wide">
                        <div class="card-header">Upgrade Application</div>
                        <div class="card-body">
                            <div class="upgrade-notice">
                                <span class="notice-icon">&#9888;</span>
                                <span class="notice-text">Upgrade will stop services, apply updates, then restart. The browser will reload automatically when complete.</span>
                            </div>

                            <div class="upgrade-options">
                                <label class="radio-option">
                                    <input type="radio" name="upgrade-source" value="github" checked>
                                    <span class="radio-label">
                                        <strong>From GitHub</strong>
                                        <small>Download latest release from GitHub repository</small>
                                    </span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="upgrade-source" value="project">
                                    <span class="radio-label">
                                        <strong>From Project Directory</strong>
                                        <small>Install from local development directory</small>
                                    </span>
                                </label>
                            </div>

                            <div class="project-selector" id="project-selector" style="display: none;">
                                <div class="project-input-group">
                                    <label>Project Directory:</label>
                                    <div class="input-with-button">
                                        <input type="text" id="project-path-input" class="office-input" placeholder="/raid0/ClaudeCodeProjects/Audiobook-Manager">
                                        <button class="office-btn" id="browse-projects" title="Browse available projects">
                                            <span class="btn-icon">&#128193;</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="project-list" id="available-projects" style="display: none;">
                                    <!-- Available projects loaded here -->
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="office-btn primary" id="start-upgrade" title="Begin upgrade process - services will restart automatically">
                                <span class="btn-icon">&#8593;</span> Start Upgrade
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Status Toast -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirm-title">Confirm Action</h2>
                <button class="modal-close" id="modal-close" title="Close dialog">&times;</button>
            </div>
            <div class="modal-body" id="confirm-body">
            </div>
            <div class="modal-footer">
                <button class="office-btn secondary" id="confirm-cancel" title="Cancel and return">Cancel</button>
                <button class="office-btn danger" id="confirm-action" title="Proceed with action">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Operation Progress Modal -->
    <div class="modal" id="progress-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="progress-title">Operation in Progress</h2>
            </div>
            <div class="modal-body">
                <div class="progress-indicator">
                    <div class="progress-spinner"></div>
                    <p id="progress-message">Processing...</p>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-wrapper modal-progress">
                        <div class="progress-bar-fill" id="modal-progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-info">
                        <span id="modal-progress-percent">0%</span>
                        <span id="modal-progress-elapsed"></span>
                    </div>
                </div>
                <div class="progress-output" id="progress-output"></div>
            </div>
            <div class="modal-footer progress-footer">
                <span id="modal-operation-id" class="operation-id"></span>
                <button class="office-btn secondary" id="modal-close-progress" style="display: none;" title="Close progress dialog">Close</button>
            </div>
        </div>
    </div>

    <script src="js/utilities.js"></script>
</body>
</html>
