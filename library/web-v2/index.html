<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Library - Audiobook Collection</title>
    <link rel="stylesheet" href="css/library.css">
</head>
<body>
    <!-- Header -->
    <header class="library-header">
        <div class="header-content">
            <div class="title-section">
                <h1 class="library-title">The Library</h1>
                <p class="library-subtitle">A Private Collection of Audiobooks</p>
            </div>
            <a href="utilities.html" class="utilities-link" title="Library Administration">
                <span class="utilities-icon">&#9881;</span>
                <span class="utilities-text">Back Office</span>
            </a>
        </div>

        <div class="library-stats">
            <div class="stat-item">
                <span class="stat-value" id="total-books">-</span>
                <span class="stat-label">volumes</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="total-hours">-</span>
                <span class="stat-label">hours</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="total-authors">-</span>
                <span class="stat-label">authors</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="total-narrators">-</span>
                <span class="stat-label">narrators</span>
            </div>
        </div>
    </header>

    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-container">
            <input type="text"
                   id="search-input"
                   class="search-input"
                   placeholder="Search books, authors, narrators...">
            <button id="clear-search" class="clear-btn">Clear</button>
        </div>

        <div class="filters-container">
            <div class="author-autocomplete" id="author-autocomplete">
                <div class="author-controls">
                    <div class="letter-groups">
                        <button class="letter-group active" data-group="all">All</button>
                        <button class="letter-group" data-group="a-e">A-E</button>
                        <button class="letter-group" data-group="f-j">F-J</button>
                        <button class="letter-group" data-group="k-o">K-O</button>
                        <button class="letter-group" data-group="p-t">P-T</button>
                        <button class="letter-group" data-group="u-z">U-Z</button>
                    </div>
                    <button class="sort-toggle" id="author-sort" title="Toggle sort order">A-Z</button>
                </div>
                <div class="author-search-row">
                    <input type="text"
                           id="author-search"
                           class="filter-select author-input"
                           placeholder="Search authors..."
                           autocomplete="off">
                    <button id="author-clear" class="author-clear" title="Clear author filter">&times;</button>
                </div>
                <div class="author-dropdown" id="author-dropdown"></div>
            </div>

            <div class="narrator-autocomplete" id="narrator-autocomplete">
                <div class="narrator-controls">
                    <div class="letter-groups">
                        <button class="letter-group active" data-group="all">All</button>
                        <button class="letter-group" data-group="a-e">A-E</button>
                        <button class="letter-group" data-group="f-j">F-J</button>
                        <button class="letter-group" data-group="k-o">K-O</button>
                        <button class="letter-group" data-group="p-t">P-T</button>
                        <button class="letter-group" data-group="u-z">U-Z</button>
                    </div>
                    <button class="sort-toggle" id="narrator-sort" title="Toggle sort order">A-Z</button>
                </div>
                <div class="narrator-search-row">
                    <input type="text"
                           id="narrator-search"
                           class="filter-select narrator-input"
                           placeholder="Search narrators..."
                           autocomplete="off">
                    <button id="narrator-clear" class="narrator-clear" title="Clear narrator filter">&times;</button>
                </div>
                <div class="narrator-dropdown" id="narrator-dropdown"></div>
            </div>

            <select id="sort-filter" class="filter-select">
                <optgroup label="Title">
                    <option value="title:asc">Title (A-Z)</option>
                    <option value="title:desc">Title (Z-A)</option>
                </optgroup>
                <optgroup label="Author">
                    <option value="author_last:asc">Author Last Name (A-Z)</option>
                    <option value="author_last:desc">Author Last Name (Z-A)</option>
                    <option value="author_first:asc">Author First Name (A-Z)</option>
                    <option value="author_first:desc">Author First Name (Z-A)</option>
                    <option value="author:asc">Author Full Name (A-Z)</option>
                    <option value="author:desc">Author Full Name (Z-A)</option>
                </optgroup>
                <optgroup label="Narrator">
                    <option value="narrator_last:asc">Narrator Last Name (A-Z)</option>
                    <option value="narrator_last:desc">Narrator Last Name (Z-A)</option>
                    <option value="narrator_first:asc">Narrator First Name (A-Z)</option>
                    <option value="narrator_first:desc">Narrator First Name (Z-A)</option>
                </optgroup>
                <optgroup label="Duration">
                    <option value="duration_hours:desc">Longest First</option>
                    <option value="duration_hours:asc">Shortest First</option>
                </optgroup>
                <optgroup label="Dates">
                    <option value="acquired_date:desc">Recently Acquired</option>
                    <option value="acquired_date:asc">Oldest Acquired</option>
                    <option value="published_year:desc">Newest Published</option>
                    <option value="published_year:asc">Oldest Published</option>
                </optgroup>
                <optgroup label="Series &amp; Editions">
                    <option value="series:asc">Series (A-Z with sequence)</option>
                    <option value="series:desc">Series (Z-A with sequence)</option>
                    <option value="edition:asc">Edition (A-Z)</option>
                </optgroup>
            </select>

            <button id="refresh-btn" class="refresh-btn">↻ Refresh</button>

            <!-- Find Duplicates Dropdown -->
            <div class="dropdown" id="duplicates-dropdown">
                <button class="dropdown-btn" id="duplicates-btn">Find Duplicates ▾</button>
                <div class="dropdown-content" id="duplicates-menu">
                    <div class="dropdown-header">Hash Generation</div>
                    <a href="#" data-action="hash-stats">View Hash Statistics</a>
                    <a href="#" data-action="hash-generate">Generate Hashes (CLI)</a>
                    <a href="#" data-action="hash-verify">Verify Hashes (CLI)</a>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-header">Duplicate Detection</div>
                    <a href="#" data-action="show-duplicates">View Duplicates</a>
                    <a href="#" data-action="duplicates-report">Full Report (CLI)</a>
                    <a href="#" data-action="duplicates-json">Export to JSON (CLI)</a>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-header">Duplicate Removal</div>
                    <a href="#" data-action="duplicates-dryrun">Dry Run (CLI)</a>
                    <a href="#" data-action="duplicates-execute" class="danger">Execute Removal (CLI)</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Collections Sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="collections-sidebar" id="collections-sidebar">
        <div class="sidebar-header">
            <h2>Collections</h2>
            <button class="sidebar-close" id="sidebar-close" title="Close sidebar">&times;</button>
        </div>
        <div class="sidebar-content" id="collections-buttons">
            <!-- Collection buttons loaded dynamically -->
        </div>
        <div class="sidebar-footer">
            <button class="sidebar-clear" id="sidebar-clear-filter">Clear Filter</button>
        </div>
    </aside>

    <!-- Results Info with Sidebar Toggle -->
    <div class="results-info">
        <div class="results-left">
            <button class="sidebar-toggle" id="sidebar-toggle" title="Browse Collections">
                <span class="toggle-icon">☰</span>
                <span class="toggle-text">Collections</span>
                <span class="active-filter" id="active-filter-badge"></span>
            </button>
            <p id="showing-count">Loading...</p>
        </div>
        <div class="pagination-controls" id="top-pagination"></div>
    </div>

    <!-- Audiobooks Grid -->
    <div class="books-grid" id="books-grid">
        <!-- Books will be loaded here -->
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
        <div class="pagination-controls" id="bottom-pagination"></div>
        <div class="per-page-control">
            <label for="per-page">Items per page:</label>
            <select id="per-page" class="filter-select">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading audiobooks...</p>
    </div>

    <!-- Hash Stats Modal -->
    <div class="modal" id="hash-stats-modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Hash Statistics</h2>
                <button class="modal-close" data-modal="hash-stats-modal">&times;</button>
            </div>
            <div class="modal-body" id="hash-stats-content">
                <div class="loading-spinner"></div>
                <p>Loading statistics...</p>
            </div>
        </div>
    </div>

    <!-- Duplicates Modal -->
    <div class="modal" id="duplicates-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Duplicate Audiobooks</h2>
                <button class="modal-close" data-modal="duplicates-modal">&times;</button>
            </div>
            <div class="duplicate-mode-tabs">
                <button class="mode-tab active" data-mode="title">Same Title/Author/Narrator</button>
                <button class="mode-tab" data-mode="hash">Exact Match (SHA-256)</button>
            </div>
            <div class="modal-toolbar">
                <div class="toolbar-left">
                    <span id="duplicates-summary">Loading...</span>
                </div>
                <div class="toolbar-right">
                    <button class="btn btn-secondary" id="select-all-duplicates">Select All Duplicates</button>
                    <button class="btn btn-secondary" id="deselect-all">Deselect All</button>
                    <button class="btn btn-danger" id="delete-selected" disabled>Delete Selected (0)</button>
                </div>
            </div>
            <div class="modal-body" id="duplicates-content">
                <div class="loading-spinner"></div>
                <p>Loading duplicates...</p>
            </div>
            <div class="modal-footer">
                <p class="safety-note">
                    <strong>Safety:</strong> The first file in each group (marked KEEP) is protected and cannot be deleted.
                    This ensures you never lose the last copy of any audiobook.
                </p>
            </div>
        </div>
    </div>

    <!-- CLI Command Modal -->
    <div class="modal" id="cli-modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>CLI Command</h2>
                <button class="modal-close" data-modal="cli-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="cli-description"></p>
                <pre class="cli-command" id="cli-command"></pre>
                <button class="btn btn-primary" id="copy-cli-command">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
                <button class="modal-close" data-modal="confirm-modal">&times;</button>
            </div>
            <div class="modal-body" id="confirm-content">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirm-cancel">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete">Delete Files</button>
            </div>
        </div>
    </div>

    <!-- Audio Player -->
    <div class="audio-player" id="audio-player" style="display: none;">
        <button class="player-close" id="close-player">×</button>

        <div class="player-info">
            <img id="player-cover" src="" alt="" class="player-cover">
            <div class="player-meta">
                <div class="player-title" id="player-title">-</div>
                <div class="player-author" id="player-author">-</div>
                <div class="player-file-info" id="player-file-info">
                    <span class="player-id" id="player-id">ID: -</span>
                    <span class="player-path" id="player-path" title="">-</span>
                </div>
            </div>
        </div>

        <div class="player-controls">
            <button class="control-btn" id="play-pause">▶</button>
            <div class="time-info">
                <span id="current-time">0:00</span>
                <span> / </span>
                <span id="total-time">0:00</span>
            </div>
        </div>

        <div class="progress-container">
            <input type="range" id="progress-bar" class="progress-bar" min="0" max="100" value="0">
        </div>

        <div class="player-extras">
            <button class="control-btn small-btn" id="rewind">-30s</button>
            <button class="control-btn small-btn" id="forward">+30s</button>
            <input type="range" id="volume" class="volume-slider" min="0" max="100" value="100">
            <span id="playback-speed">1x</span>
            <button class="control-btn small-btn" id="speed-btn">Speed</button>
        </div>

        <audio id="audio-element"></audio>
    </div>

    <script src="js/library.js"></script>
</body>
</html>
