{
  "name": "audiobooks",
  "version": "3.9.8",
  "description": "Audiobook library management with Audible sync, conversion, and web interface",
  "install_type": "system",
  "install_dir": "/opt/audiobooks",
  "service_user": "audiobooks",
  "service_group": "audiobooks",

  "github": {
    "repo": "greogory/Audiobook-Manager",
    "api": "https://api.github.com/repos/greogory/Audiobook-Manager",
    "releases": "https://github.com/greogory/Audiobook-Manager/releases"
  },

  "management_scripts": [
    {
      "name": "upgrade.sh",
      "install_path": "/opt/audiobooks/scripts/upgrade.sh",
      "wrapper": "audiobooks-upgrade",
      "description": "Upgrade from GitHub releases or local project"
    },
    {
      "name": "migrate-api.sh",
      "install_path": "/opt/audiobooks/scripts/migrate-api.sh",
      "wrapper": "audiobooks-migrate",
      "description": "Switch between API architectures"
    }
  ],

  "binaries": [
    {
      "name": "audiobooks-api",
      "paths": ["/usr/local/bin/audiobooks-api"],
      "description": "Start the API server"
    },
    {
      "name": "audiobooks-web",
      "paths": ["/usr/local/bin/audiobooks-web"],
      "description": "Start the web interface"
    },
    {
      "name": "audiobooks-scan",
      "paths": ["/usr/local/bin/audiobooks-scan"],
      "description": "Scan library for new audiobooks"
    },
    {
      "name": "audiobooks-import",
      "paths": ["/usr/local/bin/audiobooks-import"],
      "description": "Import audiobooks from sources"
    },
    {
      "name": "audiobooks-config",
      "paths": ["/usr/local/bin/audiobooks-config"],
      "description": "Manage configuration"
    },
    {
      "name": "audiobooks-convert",
      "paths": ["/usr/local/bin/audiobooks-convert"],
      "description": "Convert AAXC to Opus"
    },
    {
      "name": "audiobooks-download",
      "paths": ["/usr/local/bin/audiobooks-download"],
      "description": "Download from Audible"
    },
    {
      "name": "audiobooks-move-staged",
      "paths": ["/usr/local/bin/audiobooks-move-staged"],
      "description": "Move staged files to permanent storage"
    },
    {
      "name": "audiobooks-save-staging",
      "paths": ["/usr/local/bin/audiobooks-save-staging"],
      "description": "Save staging area before shutdown"
    },
    {
      "name": "audiobooks-upgrade",
      "paths": ["/usr/local/bin/audiobooks-upgrade"],
      "description": "Upgrade from GitHub releases"
    },
    {
      "name": "audiobooks-migrate",
      "paths": ["/usr/local/bin/audiobooks-migrate"],
      "description": "Switch API architecture"
    },
    {
      "name": "audiobooks-sync-periodicals",
      "paths": ["/opt/audiobooks/scripts/sync-periodicals-index"],
      "description": "Sync periodicals index from Audible"
    }
  ],

  "services": [
    {
      "name": "audiobooks-api.service",
      "type": "system",
      "expected_state": "active",
      "description": "API server (Waitress)",
      "health_endpoint": "http://localhost:${AUDIOBOOKS_API_PORT:-5001}/api/health"
    },
    {
      "name": "audiobooks-proxy.service",
      "type": "system",
      "expected_state": "active",
      "description": "HTTPS reverse proxy for web interface"
    },
    {
      "name": "audiobooks-redirect.service",
      "type": "system",
      "expected_state": "active",
      "description": "HTTP to HTTPS redirect"
    },
    {
      "name": "audiobooks-converter.service",
      "type": "system",
      "expected_state": "active",
      "description": "Continuous AAXC to Opus converter"
    },
    {
      "name": "audiobooks-downloader.service",
      "type": "system",
      "expected_state": "inactive",
      "description": "Audible sync (triggered by timer)"
    },
    {
      "name": "audiobooks-downloader.timer",
      "type": "system",
      "expected_state": "active",
      "description": "Timer for Audible sync"
    },
    {
      "name": "audiobooks-mover.service",
      "type": "system",
      "expected_state": "inactive",
      "description": "Staging mover (runs on-demand)"
    },
    {
      "name": "audiobooks-shutdown-saver.service",
      "type": "system",
      "expected_state": "inactive",
      "description": "Shutdown hook to save staging"
    },
    {
      "name": "audiobooks-periodicals-sync.service",
      "type": "system",
      "expected_state": "inactive",
      "description": "Periodicals index sync (triggered by timer)"
    },
    {
      "name": "audiobooks-periodicals-sync.timer",
      "type": "system",
      "expected_state": "active",
      "description": "Timer for periodicals sync (06:00, 18:00 daily)"
    },
    {
      "name": "audiobooks.target",
      "type": "system",
      "expected_state": "active",
      "description": "Target grouping all audiobook services"
    }
  ],

  "config_files": [
    {
      "path": "/etc/audiobooks/audiobooks.conf",
      "required": true,
      "description": "Main configuration file"
    },
    {
      "path": "/var/lib/audiobooks/db/audiobooks.db",
      "required": true,
      "description": "SQLite database (canonical, on NVMe)"
    }
  ],

  "data_directories": [
    {
      "path": "/opt/audiobooks",
      "required": true,
      "min_permissions": "755",
      "description": "Application installation directory"
    },
    {
      "path": "/opt/audiobooks/library",
      "required": true,
      "min_permissions": "755",
      "description": "Library code"
    },
    {
      "path": "/opt/audiobooks/scripts",
      "required": true,
      "min_permissions": "755",
      "description": "Management scripts (upgrade, migrate)"
    },
    {
      "path": "/raid0/Audiobooks",
      "required": true,
      "min_permissions": "755",
      "description": "Audiobook data storage (HDD RAID for bulk storage)"
    },
    {
      "path": "/raid0/Audiobooks/Library",
      "required": true,
      "min_permissions": "755",
      "description": "Converted audiobooks (Opus)"
    },
    {
      "path": "/raid0/Audiobooks/Sources",
      "required": true,
      "min_permissions": "755",
      "description": "Source audiobooks (AAXC)"
    },
    {
      "path": "${AUDIOBOOKS_DATA}/.covers",
      "required": false,
      "min_permissions": "755",
      "description": "Cover art cache (created as needed)"
    }
  ],

  "environment": {
    "required_vars": [
      "AUDIOBOOKS_DATA",
      "AUDIOBOOKS_LIBRARY",
      "AUDIOBOOKS_DATABASE"
    ],
    "optional_vars": [
      "AUDIOBOOKS_API_PORT",
      "AUDIOBOOKS_WEB_PORT",
      "AUDIOBOOKS_HTTPS_ENABLED",
      "AUDIOBOOKS_DEV_MODE",
      "AUDIOBOOKS_COVERS"
    ]
  },

  "ports": [
    {
      "port": 5001,
      "protocol": "tcp",
      "service": "audiobooks-api.service",
      "description": "REST API (default, configurable via AUDIOBOOKS_API_PORT)",
      "env_override": "AUDIOBOOKS_API_PORT"
    },
    {
      "port": 8443,
      "protocol": "tcp",
      "service": "audiobooks-proxy.service",
      "description": "HTTPS web interface (default, configurable via AUDIOBOOKS_WEB_PORT)",
      "env_override": "AUDIOBOOKS_WEB_PORT"
    },
    {
      "port": 8081,
      "protocol": "tcp",
      "service": "audiobooks-redirect.service",
      "description": "HTTP redirect (default, configurable via AUDIOBOOKS_HTTP_REDIRECT_PORT)",
      "env_override": "AUDIOBOOKS_HTTP_REDIRECT_PORT"
    }
  ],

  "health_checks": [
    {
      "name": "API health endpoint",
      "command": "curl -sf http://localhost:${AUDIOBOOKS_API_PORT:-5001}/health",
      "timeout": 10
    },
    {
      "name": "Web interface accessible",
      "command": "curl -sfk https://localhost:${AUDIOBOOKS_WEB_PORT:-8443}/ -o /dev/null",
      "timeout": 10
    },
    {
      "name": "Database accessible",
      "command": "test -f /var/lib/audiobooks/db/audiobooks.db && sqlite3 /var/lib/audiobooks/db/audiobooks.db 'SELECT 1'",
      "timeout": 5
    },
    {
      "name": "Library directory readable",
      "command": "test -d /raid0/Audiobooks/Library && ls /raid0/Audiobooks/Library >/dev/null",
      "timeout": 5
    }
  ]
}
